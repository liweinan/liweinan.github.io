<style>
/* Mermaid diagram container */
.mermaid-container {
  position: relative;
  display: block;
  cursor: pointer;
  transition: opacity 0.2s;
  max-width: 100%;
  margin: 20px 0;
  overflow-x: auto;
}

.mermaid-container:hover {
  opacity: 0.8;
}

.mermaid-container svg {
  max-width: 100%;
  height: auto;
  display: block;
}

/* Modal overlay */
.mermaid-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  animation: fadeIn 0.3s;
}

.mermaid-modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Modal content */
.mermaid-modal-content {
  position: relative;
  width: 90vw;
  height: 90vh;
  overflow: hidden;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}

.mermaid-modal-diagram {
  transform-origin: center center;
  transition: transform 0.2s ease;
  display: inline-block;
  min-width: 100%;
  cursor: grab;
  user-select: none;
}

.mermaid-modal-diagram.dragging {
  cursor: grabbing;
  transition: none;
}

.mermaid-modal-diagram svg {
  width: 100%;
  height: auto;
  display: block;
  pointer-events: none;
}

/* Control buttons */
.mermaid-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 8px;
  z-index: 10000;
}

.mermaid-btn {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
  color: #333;
  font-weight: 500;
}

.mermaid-btn:hover {
  background: white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Close button */
.mermaid-close {
  background: #f44336;
  color: white;
  border: none;
}

.mermaid-close:hover {
  background: #d32f2f;
}

/* Zoom indicator */
.mermaid-zoom-level {
  position: absolute;
  bottom: 20px;
  left: 20px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 14px;
  z-index: 10000;
}
</style>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    htmlLabels: true,
    themeVariables: {
      fontSize: '14px'
    }
  });

  let currentZoom = 1;
  let currentModal = null;
  let isDragging = false;
  let startX = 0;
  let startY = 0;
  let translateX = 0;
  let translateY = 0;

  // Create modal HTML
  function createModal() {
    const modal = document.createElement('div');
    modal.className = 'mermaid-modal';
    modal.innerHTML = `
      <div class="mermaid-controls">
        <button class="mermaid-btn zoom-in">放大 +</button>
        <button class="mermaid-btn zoom-out">缩小 -</button>
        <button class="mermaid-btn zoom-reset">重置</button>
        <button class="mermaid-btn mermaid-close">关闭 ✕</button>
      </div>
      <div class="mermaid-modal-content">
        <div class="mermaid-modal-diagram"></div>
      </div>
      <div class="mermaid-zoom-level">100%</div>
    `;
    document.body.appendChild(modal);
    return modal;
  }

  // Show modal with diagram
  function showModal(diagramContent) {
    if (!currentModal) {
      currentModal = createModal();
      setupModalEvents();
    }

    const modalDiagram = currentModal.querySelector('.mermaid-modal-diagram');
    modalDiagram.innerHTML = diagramContent;

    // Remove any width/height attributes from SVG to make it responsive
    const svg = modalDiagram.querySelector('svg');
    if (svg) {
      svg.removeAttribute('width');
      svg.removeAttribute('height');
      svg.style.width = '100%';
      svg.style.height = 'auto';
    }

    // Setup drag functionality
    setupDrag(modalDiagram);

    currentModal.classList.add('active');
    currentZoom = 1;
    resetPosition();
    updateZoom();
    document.body.style.overflow = 'hidden';
  }

  // Hide modal
  function hideModal() {
    if (currentModal) {
      currentModal.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  // Update zoom level
  function updateZoom() {
    if (!currentModal) return;
    const diagram = currentModal.querySelector('.mermaid-modal-diagram');
    const zoomLevel = currentModal.querySelector('.mermaid-zoom-level');
    diagram.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
    zoomLevel.textContent = `${Math.round(currentZoom * 100)}%`;
  }

  // Reset position when zoom changes
  function resetPosition() {
    translateX = 0;
    translateY = 0;
  }

  // Setup drag functionality
  function setupDrag(element) {
    element.addEventListener('mousedown', startDrag);
    element.addEventListener('touchstart', startDrag);
  }

  function startDrag(e) {
    if (e.type === 'mousedown' && e.button !== 0) return; // Only left click

    isDragging = true;
    const modalDiagram = currentModal.querySelector('.mermaid-modal-diagram');
    modalDiagram.classList.add('dragging');

    if (e.type === 'touchstart') {
      startX = e.touches[0].clientX - translateX;
      startY = e.touches[0].clientY - translateY;
    } else {
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
    }

    document.addEventListener('mousemove', drag);
    document.addEventListener('touchmove', drag);
    document.addEventListener('mouseup', stopDrag);
    document.addEventListener('touchend', stopDrag);
  }

  function drag(e) {
    if (!isDragging) return;
    e.preventDefault();

    if (e.type === 'touchmove') {
      translateX = e.touches[0].clientX - startX;
      translateY = e.touches[0].clientY - startY;
    } else {
      translateX = e.clientX - startX;
      translateY = e.clientY - startY;
    }

    updateZoom();
  }

  function stopDrag() {
    isDragging = false;
    const modalDiagram = currentModal?.querySelector('.mermaid-modal-diagram');
    if (modalDiagram) {
      modalDiagram.classList.remove('dragging');
    }
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('touchmove', drag);
    document.removeEventListener('mouseup', stopDrag);
    document.removeEventListener('touchend', stopDrag);
  }

  // Setup modal event listeners
  function setupModalEvents() {
    if (!currentModal) return;

    // Close button
    currentModal.querySelector('.mermaid-close').addEventListener('click', hideModal);

    // Zoom buttons
    currentModal.querySelector('.zoom-in').addEventListener('click', () => {
      currentZoom = Math.min(currentZoom + 0.25, 3);
      updateZoom();
    });

    currentModal.querySelector('.zoom-out').addEventListener('click', () => {
      currentZoom = Math.max(currentZoom - 0.25, 0.5);
      updateZoom();
    });

    currentModal.querySelector('.zoom-reset').addEventListener('click', () => {
      currentZoom = 1;
      resetPosition();
      updateZoom();
    });

    // Close on background click
    currentModal.addEventListener('click', (e) => {
      if (e.target === currentModal) {
        hideModal();
      }
    });

    // Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && currentModal.classList.contains('active')) {
        hideModal();
      }
    });
  }

  // Convert Jekyll-rendered code blocks to mermaid divs
  document.addEventListener('DOMContentLoaded', async function() {
    const codeBlocks = document.querySelectorAll('code.language-mermaid');

    for (const codeBlock of codeBlocks) {
      const pre = codeBlock.parentElement;
      const container = document.createElement('div');
      container.className = 'mermaid-container';

      const mermaidDiv = document.createElement('div');
      mermaidDiv.className = 'mermaid';
      mermaidDiv.textContent = codeBlock.textContent;

      container.appendChild(mermaidDiv);
      pre.replaceWith(container);
    }

    // Render all mermaid diagrams
    try {
      await mermaid.run({
        querySelector: '.mermaid'
      });
      console.log('Mermaid diagrams rendered successfully');
    } catch (error) {
      console.error('Mermaid rendering error:', error);
    }

    // Add click handlers to rendered diagrams
    document.querySelectorAll('.mermaid-container').forEach((container, index) => {
      // Find the rendered SVG inside the container
      const svg = container.querySelector('svg');
      if (!svg) {
        console.warn(`No SVG found in container ${index}`);
        return;
      }

      // Make the container clickable
      container.style.cursor = 'pointer';
      container.title = '点击查看大图';

      container.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Clone the SVG for the modal
        const svgClone = svg.cloneNode(true);
        const tempDiv = document.createElement('div');
        tempDiv.appendChild(svgClone);

        console.log('Opening modal for diagram', index);
        showModal(tempDiv.innerHTML);
      });

      console.log(`Click handler added to diagram ${index}`);
    });
  });
</script>
